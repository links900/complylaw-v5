{% load groupby_filters %}
{% load scan_filters %}
{% load tz %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Compliance Report - {{ scan.domain }}</title>

    <style>
        /* Page Setup for WeasyPrint */
        @page {
            size: A4;
            margin: 1.5cm 1.5cm 4cm 1.5cm; /* extra bottom for footer */

            /* Footer text on left */
			@bottom-left {
				content: "ID: #{{ scan.scan_id }} | {{ scan.scan_date|date:'M d, Y g:i A' }} | ComplyLaw AI Scanner";
				font-size: 9px;
				color: #666;
			}
			/* Footer text in center */
            @bottom-center {
                content: " Page " counter(page) " of " counter(pages);
                font-size: 9px;
                color: #666;
            }

            /* Footer QR on right */
            @bottom-right {
                content: url('https://api.qrserver.com/v1/create-qr-code/?size=50x50&data=https://complylaw.com/report/{{ scan.scan_id }}');
            }
        }

        body {
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.4;
            color: #333;
        }

        .content-wrapper {
            padding-bottom: 20px;
        }

        /* Cover Page */
        .cover-page {
            text-align: center;
            padding-top: 40px;
            page-break-after: always;
        }

        .cover-center {
            margin-top: 180px;      /* set vertical spacing here */
			margin-bottom: 300px;  /* spacing before signature */
        }
		
		.cover-center h1 {
			font-size: 28px; /* bigger than before */
			color: #1a5fb4;
			margin-bottom: 20px;
		}

		.cover-center .standards {
			font-size: 16px; /* bigger than default 13px */
			margin-bottom: 15px;
		}

		.cover-center .audit-meta {
			font-size: 14px; /* bigger than default 12px */
			line-height: 1.6;
		}


        .subtitle { font-size: 14px; margin-top: 5px; margin-bottom: 20px; }
        .standards { font-size: 13px; margin-top: 10px; }
        .audit-meta { margin-top: 20px; font-size: 12px; line-height: 1.5; }

        .signature {
            margin-top: 120px;
            font-style: italic;
            text-align: right;
            padding-right: 10px;
            font-size: 12px;
        }

        /* Typography */
        h1 { color: #1a5fb4; text-align: center; font-size: 18px; }
        h2 { color: #1a5fb4; font-size: 14px; border-bottom: 1px solid #1a5fb4; padding-bottom: 5px; }
        h3 { color: #1e40af; font-size: 1.3rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.4rem; }

        /* Summary */
        .summary {
				display: flex;
				justify-content: space-around;
				flex-wrap: wrap;
				gap: 1rem;
				background: #f8fafc;
				padding: 1rem;
				border-radius: 8px;
				margin-bottom: 1.5rem;
				align-items: flex-end; /* aligns all items to the bottom */
			}

			.summary-item {
				text-align: center;
				min-width: 120px;
			}

			.summary-value {
				font-size: 1.5rem;   /* bigger than h4 */
				font-weight: bold;
				margin: 0;           /* remove extra spacing */
			}


        .grade-badge {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            margin-bottom: 0.5rem;
        }

        .grade-A { background: #10b981; }
        .grade-B { background: #3b82f6; }
        .grade-C { background: #f59e0b; }
        .grade-D { background: #f97316; }
        .grade-F { background: #ef4444; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 10px;
            page-break-inside: auto;
        }

        tr { page-break-inside: avoid; page-break-after: auto; }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th { background-color: #f0f7ff; }
        tr:nth-child(even) { background: #f8fafc; }

        .risk-low { color: #10b981; font-weight: 600; }
        .risk-medium { color: #f59e0b; font-weight: 600; }
        .risk-high { color: #ef4444; font-weight: 600; }

        .recommendations {
            background: #fef3c7;
            padding: 1rem;
            border-left: 4px solid #f59e0b;
            margin: 1rem 0;
            border-radius: 0 4px 4px 0;
        }

        .priority-high { color: #ef4444; font-weight: bold; }
        .priority-medium { color: #f59e0b; }
        .priority-low { color: #10b981; }

        .box {
            border: 2px solid #1a5fb4;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8fbff;
        }

        hr.dashed { border-top: 1px dashed #ccc; margin: 30px 0; }

    </style>
</head>
<body>

<!-- PAGE 1 COVER -->
<div class="cover-page">
    <h1>ComplyNet Consulting Partners</h1>
    <p class="subtitle">
        <strong>Cybersecurity • Compliance • Digital Risk • Web Security</strong>
    </p>
    <hr class="dashed">
    <div class="cover-center">
        <h1>Cyber Security Audit & Compliance Report</h1>
        <p class="standards">GDPR | ISO 27001 | OWASP | PCI DSS | Supply Chain</p>
        <p class="audit-meta">
            Website: {{ scan.domain }}<br>
            Audit Date: {{ scan.scan_date|date:"F j, Y" }}<br>
            Report ID: #{{ scan.scan_id }}
        </p>
    </div>
    <div class="signature">
        /s/ Engr. M Imran, Executive Cybersecurity Advisor to Government & Global Enterprises<br>
        Governance, Digital Risk, Compliance & Resilience Strategist<br>
        {{ scan.scan_date|date:"F j, Y" }}
    </div>
</div>

<div style="page-break-before: always;"></div>

<!-- CONTENT -->
<div class="content-wrapper">

    <!-- Summary -->
    <div class="summary">
		<div class="summary-item">
			<div class="grade-badge grade-{{ scan.grade|default:'F' }}">
				{{ scan.grade|default:"—" }}
			</div>
			<h4>Compliance Grade</h4>
		</div>

		<div class="summary-item">
			<p class="summary-value">{{ scan.risk_score|floatformat:0 }}%</p>
			<h4>Risk Score</h4>
		</div>

		<div class="summary-item">
			<p class="summary-value">{{ findings|length }}</p>
			<h4>Issues Found</h4>
		</div>
	</div>


    <!-- Executive Summary -->
    <div class="section">
        <h3>Executive Summary</h3>
        <p>This assessment provides an independent, high-confidence evaluation of {{ scan.domain }} against GDPR, CCPA, and international cybersecurity expectations. The objective is to determine regulatory exposure, security posture, and insurer-relevant operational risk.</p>

        <p>Based on automated analysis and expert-mapped heuristics, the website currently holds a <strong>Grade {{ scan.grade|default:"—" }}</strong> with a risk score of <strong>{{ scan.risk_score|floatformat:0 }}%</strong>. A total of <strong>{{ findings|length }}</strong> compliance-impacting issues were identified.</p>
		
		{% if scan.grade in 'AB' %}
		<p>Strong compliance posture. Core regulatory controls are in place.</p>
		{% elif scan.grade == 'C' %}
		<p>Moderate gaps exist. Several foundational controls require attention.</p>
		{% else %}
		<p>Critical deficiencies detected. Immediate remediation required.</p>
		{% endif %}

        <p>This report uses insurer-aligned severity scales and remediation forecasts. It helps demonstrate due diligence, evidences proactive risk management, and documents the organization’s commitment to regulatory maturity.</p>
		
		
		
    </div>
	
	
	<!-- Findings Overview -->
    <div class="section">
        <h3>Detailed Findings by Framework</h3>
        		
		<p>Below is non exhaustive list of compliance with respect to various standarads. If there was no observation in findings that section has been removed from the report .</p>
		
    </div>

    <!-- Findings Table -->
    {% for group in findings|groupby_module %}
        <h2>{{ forloop.counter }}: {{ group.module }} Compliance Report</h2>
        <table>
            <tr>
                <th>Article</th>
                <th>Finding</th>
                <th>Risk</th>
                <th>Evidence</th>
            </tr>
            {% for f in group.items %}
            <tr>
                <td>{{ f.standard }}</td>
                <td>{{ f.title }}</td>
                
				<td class="{% if f.risk_level|default:'' == 'high' %}risk-high{% elif f.risk_level|default:'' == 'medium' %}risk-medium{% elif f.risk_level|default:'' == 'low' %}risk-low{% endif %}">
					{{ f.risk_level|default:"—" }}
				</td>

                <td>{{ f.details }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endfor %}

    <!-- Recommendations -->
    {% if recommendations %}
    <div class="section">
        <h3>Recommendations</h3>
        {% for rec in recommendations %}
        <div class="recommendations">
            <strong>{{ rec.title }}</strong><br>
            <span class="priority-{{ rec.priority|lower }}">Priority: {{ rec.priority }}</span><br>
            {{ rec.description|linebreaksbr }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Strategic Risk -->
    <div class="section">
        <h3>Strategic Risk Perspective</h3>
        <p>The modern threat landscape is no longer a contest of firewalls and forms. It is an information battlefield.</p>
        <p>Every unprotected endpoint becomes a liability. Every unsecured cookie banner becomes a legal vector. Every deficiency in data governance becomes an invitation for scrutiny.</p>
        <p>These findings represent structural weak points that adversaries, auditors, and litigators can exploit.</p>
        <p>Addressing these issues reduces legal exposure, improves insurability, and reinforces operational resilience.</p>
    </div>

    <h2>Insurance Certification Statement</h2>
     <div class="box">
        <p>ComplyNet Consulting Partners certifies that the findings are based on independent automated technical scans (Burp Suite, Qualys, OpenVAS) and stakeholder interviews (where applicable) conducted on {{ scan.scan_date|date:"F j, Y" }}.</p>
		
		<p>Checklist responses and policy reviews are self-attested by the organization and were not independently verified.</p>
		
        <p>The client Risk Score is {{ scan.risk_score|floatformat:0 }}% with Compliance Grade {{ scan.grade|default:"—" }} .It achieves 61% aggregate compliance with material gaps in ISO 27001 and GDPR cookie consent. Implementation of P0–P2 roadmap will increase score to 89% within 180 days.</p>
    </div>

</div>
</body>
</html>
