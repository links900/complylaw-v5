<!-- templates/users/firm_wizard.html -->


{% extends "base.html" %}
{% block title %}Setup Your Organization - ComplyLaw{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-12" x-data="{ step: 1, auditType: 'detailed' }">
    <div class="mb-12">
        <div class="flex items-center justify-between relative">
            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -z-10"></div>
            <div class="absolute top-1/2 left-0 h-0.5 bg-indigo-600 transition-all duration-500 -z-10" :style="'width: ' + ((step-1)*33.33) + '%'"></div>
            
            <div class="flex flex-col items-center">
                <div :class="step >= 1 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">1</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Identity</span>
            </div>
            <div class="flex flex-col items-center">
                <div :class="step >= 2 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">2</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Region</span>
            </div>
            <div class="flex flex-col items-center">
                <div :class="step >= 3 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">3</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Compliance</span>
            </div>
            <div class="flex flex-col items-center">
                <div :class="step >= 4 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">4</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Finalize</span>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/60 border border-slate-100 overflow-hidden">
        <div class="p-8 sm:p-12">
            <header class="text-center mb-10">
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 1">Tell us about your firm</h2>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 2">Regional & Data Preferences</h2>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 3">Primary Framework</h2>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 4">Branding & Final Touches</h2>
                <p class="text-slate-500 mt-2">Configure your workspace for global enterprise standards.</p>
            </header>

            {% if form.errors %}
            <div class="mb-8 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                <div class="flex">
                    <div class="ml-3 text-sm text-red-700 font-medium">Please review the errors in the form.</div>
                </div>
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="wizard-form">
                {% csrf_token %}
				
				{% if form.errors %}
					<div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
						<div class="flex">
							<div class="ml-3">
								<p class="text-sm text-red-700 font-bold">Please correct the following:</p>
								<ul class="list-disc ml-5 text-sm text-red-600">
									{% for field, errors in form.errors.items %}
										{% for error in errors %}
											<li>{{ field|title }}: {{ error }}</li>
										{% endfor %}
									{% endfor %}
								</ul>
							</div>
						</div>
					</div>
				{% endif %}

                <div x-show="step === 1" x-transition.opacity>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Firm Legal Name *</label>
                                {{ form.firm_name }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Corporate Email *</label>
                                {{ form.email }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Global Phone Number *</label>
                                {{ form.phone }}
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Public Domain</label>
                                <div class="flex rounded-lg shadow-sm border border-slate-300 focus-within:ring-2 focus-within:ring-indigo-500 overflow-hidden">
                                    <span class="inline-flex items-center px-4 text-slate-400 bg-slate-50 text-sm border-r border-slate-300">https://</span>
                                    <div class="flex-1 [&>input]:border-0 [&>input]:focus:ring-0 [&>input]:w-full">
                                        {{ form.domain }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="step === 2" x-transition.opacity>
                    <div class="space-y-8">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Business Timezone</label>
                            {{ form.timezone }}
                            <p class="text-xs text-slate-500 mt-2 italic">Essential for audit log timestamps.</p>
                        </div>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Currency</label>
                                {{ form.currency }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Date Format</label>
                                {{ form.date_format }}
                            </div>
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                            <label class="block text-sm font-bold text-indigo-900 mb-2">Data Residency (Sovereignty)</label>
                            <select name="data_region" class="w-full rounded-lg border-slate-300 text-sm py-2.5">
                                <option value="us">United States (Standard)</option>
                                <option value="eu">European Union (GDPR Optimized)</option>
                                <option value="asia">Asia Pacific</option>
                            </select>
                            <p class="text-[10px] text-indigo-700 mt-2 font-medium uppercase tracking-tighter">Enterprise Exclusive: Directs where your scan data is physically stored.</p>
                        </div>
                    </div>
                </div>

				<div x-show="step === 3" x-transition.opacity 
					 x-data="{ selectedStandard: '{{ available_standards.0.name }}' }">
					
					<div class="space-y-6">
						<div class="flex items-center justify-between border-b border-slate-100 pb-4">
							<div>
								<h3 class="text-lg font-bold text-slate-900">Primary Compliance Framework</h3>
								<p class="text-xs text-slate-500">Select the main standard for your initial audit checklist.</p>
							</div>
							<div class="text-right">
								<span class="text-[10px] font-black text-amber-600 uppercase tracking-widest block">Subscription Tier</span>
								<span class="text-sm font-bold text-slate-700 uppercase">{{ user_tier }}</span>
							</div>
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
							{% for standard in available_standards %}
							{% with std_id=standard.name|lower|cut:" " %}
							<label for="std_{{ std_id }}" 
								   class="relative flex items-center p-4 border rounded-xl cursor-pointer transition-all group bg-white shadow-sm"
								   :class="selectedStandard === '{{ standard.name }}' ? 'border-indigo-600 ring-2 ring-indigo-600/10 bg-indigo-50/30' : 'border-slate-200 hover:border-indigo-300'">
								
								<input type="radio" 
									   id="std_{{ std_id }}"
									   name="active_standard" 
									   value="{{ standard.name }}" 
									   x-model="selectedStandard"
									   class="sr-only"
									   required>
								
								<div class="flex flex-col flex-1 pr-4">
									<div class="flex items-center gap-2">
										<span class="text-sm font-bold" :class="selectedStandard === '{{ standard.name }}' ? 'text-indigo-700' : 'text-slate-900'">
											{{ standard.name }}
										</span>
										<span class="text-[9px] font-bold px-1.5 py-0.5 rounded bg-white border border-slate-200 text-slate-600 uppercase">
											{{ standard.scope_tag }}
										</span>
									</div>
									<p class="text-[11px] text-slate-500 leading-tight mt-1 line-clamp-2">
										{{ standard.one_liner }}
									</p>
								</div>

								<div class="shrink-0">
									<div class="w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all"
										 :class="selectedStandard === '{{ standard.name }}' ? 'border-indigo-600' : 'border-slate-200'">
										<div class="w-2.5 h-2.5 rounded-full bg-indigo-600 transition-transform"
											 :class="selectedStandard === '{{ standard.name }}' ? 'scale-100' : 'scale-0'">
										</div>
									</div>
								</div>
							</label>
							{% endwith %}
							{% endfor %}
						</div>

						<div class="bg-slate-50 p-5 rounded-2xl border border-slate-200 mt-6">
							<div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
								<div>
									<label class="block text-sm font-bold text-slate-700">Audit Rigor</label>
									<p class="text-[11px] text-slate-500">Simple uses basic verification; Detailed requires evidence.</p>
								</div>
								<div class="flex bg-white p-1 rounded-lg border border-slate-200 shadow-sm shrink-0">
									<button type="button" @click="auditType = 'simple'" :class="auditType === 'simple' ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-500'" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all">Simple</button>
									<button type="button" @click="auditType = 'detailed'" :class="auditType === 'detailed' ? 'bg-indigo-600 text-white shadow-sm' : 'text-slate-500'" class="px-4 py-1.5 text-xs font-bold rounded-md transition-all">Detailed</button>
								</div>
							</div>
							<input type="hidden" name="audit_rigor" :value="auditType">
						</div>
						
						<div class="space-y-4">
							<div class="flex items-center justify-between">
								<label class="block text-sm font-bold text-slate-700">Data Retention Policy</label>
								<span class="text-[10px] font-bold px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full uppercase tracking-wide">GDPR Compliant</span>
							</div>

							<div class="grid grid-cols-1 sm:grid-cols-3 gap-3" x-data="{ retention: '365' }">
								<label class="relative flex flex-col p-4 border rounded-xl cursor-pointer transition-all hover:bg-slate-50"
									   :class="retention === '365' ? 'border-indigo-600 ring-1 ring-indigo-600 bg-indigo-50/30' : 'border-slate-200'">
									<input type="radio" name="retention_days" value="365" x-model="retention" class="sr-only">
									<span class="text-lg font-bold text-slate-900">1 Year</span>
									<span class="text-[10px] text-slate-500 uppercase font-medium">Standard</span>
								</label>

								<label class="relative flex flex-col p-4 border rounded-xl cursor-pointer transition-all hover:bg-slate-50"
									   :class="retention === '730' ? 'border-indigo-600 ring-1 ring-indigo-600 bg-indigo-50/30' : 'border-slate-200'">
									<input type="radio" name="retention_days" value="730" x-model="retention" class="sr-only">
									<span class="text-lg font-bold text-slate-900">2 Years</span>
									<span class="text-[10px] text-slate-500 uppercase font-medium">Enhanced</span>
								</label>

								<label class="relative flex flex-col p-4 border rounded-xl cursor-pointer transition-all hover:bg-slate-50"
									   :class="retention === '2555' ? 'border-indigo-600 ring-1 ring-indigo-600 bg-indigo-50/30' : 'border-slate-200'">
									<input type="radio" name="retention_days" value="2555" x-model="retention" class="sr-only">
									<span class="text-lg font-bold text-slate-900">7 Years</span>
									<span class="text-[10px] text-slate-500 uppercase font-medium">Legal/Tax</span>
								</label>
							</div>

							<p class="text-[11px] text-slate-500 leading-relaxed italic">
								* Evidence logs and audit trails will be cryptographically purged following the end of this period to remain compliant with Right to Erasure (GDPR Art. 17).
							</p>
						</div>


					</div>
				</div>
							   
				
                <div x-show="step === 4" x-transition.opacity>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Company Headquarters Address</label>
                            {{ form.address }}
                        </div>
                        <div class="p-6 border-2 border-dashed border-slate-200 rounded-xl hover:border-indigo-400 transition-colors group bg-slate-50/30">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Corporate Logo</label>
                            {{ form.logo }}
                            <p class="text-[11px] text-slate-500 mt-2">Recommended: White background, 400x100px PNG. This logo will appear on all automated compliance reports.</p>
                        </div>
                        <div class="relative p-5 bg-amber-50 rounded-xl border border-amber-100 overflow-hidden">
                            <label class="block text-sm font-bold text-amber-900 mb-1">Assigned Tier</label>
                            {{ form.subscription_tier }}
                            <div class="absolute -right-2 -bottom-2 opacity-10">
                                <svg class="w-20 h-20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-slate-100 flex items-center justify-between">
                    <button type="button" x-show="step > 1" @click="step--" 
                        class="px-6 py-2.5 text-sm font-bold text-slate-600 hover:text-slate-900 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back
                    </button>
                    <div x-show="step === 1"></div> 

                    <button type="button" x-show="step < 4" @click="step++" 
                        class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                        Continue
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>

                    <button type="submit" x-show="step === 4" 
                        class="px-8 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition-all">
                        Complete Setup & Launch
                    </button>
                </div>
				
				
            </form>
        </div>
    </div>
    
    <p class="text-center text-slate-400 text-sm mt-8">
        By completing setup, you agree to our <a href="#" class="text-indigo-500 underline decoration-indigo-200">Global Privacy Shield</a> protocols.
    </p>
</div>

<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all visual checkboxes
        const checkboxes = document.querySelectorAll('.framework-ref');
        // Find the hidden textarea created by Django for JSONField
        const hiddenJsonField = document.querySelector('[name="selected_frameworks"]');

        function updateJson() {
            const values = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Set the value as a JSON string: e.g. ["gdpr", "iso27001"]
            hiddenJsonField.value = JSON.stringify(values);
        }

        // Listen for clicks
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateJson);
        });

        // Initialize with empty array if empty
        if (!hiddenJsonField.value || hiddenJsonField.value === "null") {
            hiddenJsonField.value = "[]";
        }
    });
</script>


{% endblock %}
