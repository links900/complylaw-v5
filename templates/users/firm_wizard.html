<!-- templates/users/firm_wizard.html -->


{% extends "base.html" %}
{% block title %}Setup Your Organization - ComplyLaw{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-12" x-data="{ step: 1, auditType: 'detailed' }">
    <div class="mb-12">
        <div class="flex items-center justify-between relative">
            <div class="absolute top-1/2 left-0 w-full h-0.5 bg-slate-200 -z-10"></div>
            <div class="absolute top-1/2 left-0 h-0.5 bg-indigo-600 transition-all duration-500 -z-10" :style="'width: ' + ((step-1)*33.33) + '%'"></div>
            
            <div class="flex flex-col items-center">
                <div :class="step >= 1 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">1</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Identity</span>
            </div>
            <div class="flex flex-col items-center">
                <div :class="step >= 2 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">2</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Region</span>
            </div>
            <div class="flex flex-col items-center">
                <div :class="step >= 3 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">3</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Compliance</span>
            </div>
            <div class="flex flex-col items-center">
                <div :class="step >= 4 ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-400 border-slate-200'" class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold transition-colors">4</div>
                <span class="text-xs font-semibold mt-2 text-slate-600 uppercase tracking-wider">Finalize</span>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl shadow-slate-200/60 border border-slate-100 overflow-hidden">
        <div class="p-8 sm:p-12">
            <header class="text-center mb-10">
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 1">Tell us about your firm</h2>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 2">Regional & Data Preferences</h2>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 3">Select Compliance Standards</h2>
                <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight" x-show="step === 4">Branding & Final Touches</h2>
                <p class="text-slate-500 mt-2">Configure your workspace for global enterprise standards.</p>
            </header>

            {% if form.errors %}
            <div class="mb-8 p-4 bg-red-50 border-l-4 border-red-500 rounded-r-lg">
                <div class="flex">
                    <div class="ml-3 text-sm text-red-700 font-medium">Please review the errors in the form.</div>
                </div>
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="wizard-form">
                {% csrf_token %}
				
				{% if form.errors %}
					<div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
						<div class="flex">
							<div class="ml-3">
								<p class="text-sm text-red-700 font-bold">Please correct the following:</p>
								<ul class="list-disc ml-5 text-sm text-red-600">
									{% for field, errors in form.errors.items %}
										{% for error in errors %}
											<li>{{ field|title }}: {{ error }}</li>
										{% endfor %}
									{% endfor %}
								</ul>
							</div>
						</div>
					</div>
				{% endif %}

                <div x-show="step === 1" x-transition.opacity>
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div class="col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Firm Legal Name *</label>
                                {{ form.firm_name }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Corporate Email *</label>
                                {{ form.email }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Global Phone Number *</label>
                                {{ form.phone }}
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Public Domain</label>
                                <div class="flex rounded-lg shadow-sm border border-slate-300 focus-within:ring-2 focus-within:ring-indigo-500 overflow-hidden">
                                    <span class="inline-flex items-center px-4 text-slate-400 bg-slate-50 text-sm border-r border-slate-300">https://</span>
                                    <div class="flex-1 [&>input]:border-0 [&>input]:focus:ring-0 [&>input]:w-full">
                                        {{ form.domain }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div x-show="step === 2" x-transition.opacity>
                    <div class="space-y-8">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Business Timezone</label>
                            {{ form.timezone }}
                            <p class="text-xs text-slate-500 mt-2 italic">Essential for audit log timestamps.</p>
                        </div>
                        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Currency</label>
                                {{ form.currency }}
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Date Format</label>
                                {{ form.date_format }}
                            </div>
                        </div>
                        <div class="p-4 bg-indigo-50 rounded-xl border border-indigo-100">
                            <label class="block text-sm font-bold text-indigo-900 mb-2">Data Residency (Sovereignty)</label>
                            <select name="data_region" class="w-full rounded-lg border-slate-300 text-sm py-2.5">
                                <option value="us">United States (Standard)</option>
                                <option value="eu">European Union (GDPR Optimized)</option>
                                <option value="asia">Asia Pacific</option>
                            </select>
                            <p class="text-[10px] text-indigo-700 mt-2 font-medium uppercase tracking-tighter">Enterprise Exclusive: Directs where your scan data is physically stored.</p>
                        </div>
                    </div>
                </div>

                <div x-show="step === 3" x-transition.opacity>
					<div class="space-y-8">
						
						<div class="hidden">
							{{ form.selected_frameworks }}
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<label class="relative flex p-4 border-2 rounded-xl cursor-pointer hover:bg-slate-50 transition-all group">
								<input type="checkbox" value="iso27001" class="framework-ref sr-only peer">
								<div class="flex flex-col">
									<span class="text-sm font-extrabold text-slate-900">ISO/IEC 27001</span>
									<span class="text-xs text-slate-500 mt-1">Information Security Mgmt</span>
									<span class="mt-3 inline-flex items-center text-[10px] font-bold text-indigo-600 uppercase tracking-widest bg-indigo-50 px-2 py-0.5 rounded w-fit">Enterprise</span>
								</div>
								<div class="ml-auto opacity-0 peer-checked:opacity-100 text-indigo-600 transition-opacity">
									<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
								</div>
								<div class="absolute inset-0 border-2 border-transparent peer-checked:border-indigo-600 rounded-xl pointer-events-none"></div>
							</label>

							<label class="relative flex p-4 border-2 rounded-xl cursor-pointer hover:bg-slate-50 transition-all">
								<input type="checkbox" value="gdpr" class="framework-ref sr-only peer">
								<div class="flex flex-col">
									<span class="text-sm font-extrabold text-slate-900">GDPR Compliance</span>
									<span class="text-xs text-slate-500 mt-1">Data Protection & Privacy</span>
									<span class="mt-3 inline-flex items-center text-[10px] font-bold text-emerald-600 uppercase tracking-widest bg-emerald-50 px-2 py-0.5 rounded w-fit">Professional</span>
								</div>
								<div class="ml-auto opacity-0 peer-checked:opacity-100 text-indigo-600 transition-opacity">
									<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
								</div>
								<div class="absolute inset-0 border-2 border-transparent peer-checked:border-indigo-600 rounded-xl pointer-events-none"></div>
							</label>
						</div>

						<div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
							<label class="block text-sm font-bold text-slate-700 mb-4 text-center">Audit Rigor Level</label>
							<div class="flex bg-white p-1 rounded-lg border border-slate-200 max-w-sm mx-auto shadow-sm">
								<button type="button" @click="auditType = 'simple'" :class="auditType === 'simple' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-900'" class="flex-1 py-2 text-xs font-bold rounded-md transition-all">
									Simple Checklist
								</button>
								<button type="button" @click="auditType = 'detailed'" :class="auditType === 'detailed' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-slate-900'" class="flex-1 py-2 text-xs font-bold rounded-md transition-all">
									Detailed Audit
								</button>
							</div>
							<div class="mt-4 text-center">
								<p x-show="auditType === 'simple'" class="text-[11px] text-slate-500">Fast "Yes/No" verification. Best for small firms and internal self-assessments.</p>
								<p x-show="auditType === 'detailed'" class="text-[11px] text-slate-500"><strong>Enterprise Standard:</strong> Requires PDF evidence uploads and multi-step stakeholder approval.</p>
							</div>
							<input type="hidden" name="audit_rigor" :value="auditType">
						</div>
						
						<div class="space-y-2">
							<label class="block text-sm font-bold text-slate-700">Data Retention (Days)</label>
							{{ form.retention_days }}
							<p class="text-xs text-slate-500">How many days should we keep your scan logs? (e.g., 30, 90, 365)</p>
						</div>
					</div>
				</div>


                <div x-show="step === 4" x-transition.opacity>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Company Headquarters Address</label>
                            {{ form.address }}
                        </div>
                        <div class="p-6 border-2 border-dashed border-slate-200 rounded-xl hover:border-indigo-400 transition-colors group bg-slate-50/30">
                            <label class="block text-sm font-bold text-slate-700 mb-2">Corporate Logo</label>
                            {{ form.logo }}
                            <p class="text-[11px] text-slate-500 mt-2">Recommended: White background, 400x100px PNG. This logo will appear on all automated compliance reports.</p>
                        </div>
                        <div class="relative p-5 bg-amber-50 rounded-xl border border-amber-100 overflow-hidden">
                            <label class="block text-sm font-bold text-amber-900 mb-1">Assigned Tier</label>
                            {{ form.subscription_tier }}
                            <div class="absolute -right-2 -bottom-2 opacity-10">
                                <svg class="w-20 h-20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12 pt-8 border-t border-slate-100 flex items-center justify-between">
                    <button type="button" x-show="step > 1" @click="step--" 
                        class="px-6 py-2.5 text-sm font-bold text-slate-600 hover:text-slate-900 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        Back
                    </button>
                    <div x-show="step === 1"></div> 

                    <button type="button" x-show="step < 4" @click="step++" 
                        class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                        Continue
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </button>

                    <button type="submit" x-show="step === 4" 
                        class="px-8 py-3 bg-emerald-600 text-white rounded-lg font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-200 transition-all">
                        Complete Setup & Launch
                    </button>
                </div>
				
				
            </form>
        </div>
    </div>
    
    <p class="text-center text-slate-400 text-sm mt-8">
        By completing setup, you agree to our <a href="#" class="text-indigo-500 underline decoration-indigo-200">Global Privacy Shield</a> protocols.
    </p>
</div>

<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Find all visual checkboxes
        const checkboxes = document.querySelectorAll('.framework-ref');
        // Find the hidden textarea created by Django for JSONField
        const hiddenJsonField = document.querySelector('[name="selected_frameworks"]');

        function updateJson() {
            const values = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Set the value as a JSON string: e.g. ["gdpr", "iso27001"]
            hiddenJsonField.value = JSON.stringify(values);
        }

        // Listen for clicks
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateJson);
        });

        // Initialize with empty array if empty
        if (!hiddenJsonField.value || hiddenJsonField.value === "null") {
            hiddenJsonField.value = "[]";
        }
    });
</script>


{% endblock %}
